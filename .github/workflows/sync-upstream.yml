name: Sync upstream and release

on:
  schedule:
    # 每 6 小时检查一次 (UTC 0:00, 6:00, 12:00, 18:00)
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Check upstream latest release
      id: check
      run: |
        # 获取上游最新稳定版 release 完整信息
        UPSTREAM_RELEASE=$(curl -s https://api.github.com/repos/2dust/v2rayN/releases/latest)
        UPSTREAM_TAG=$(echo "$UPSTREAM_RELEASE" | jq -r '.tag_name')
        echo "upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
        echo "上游最新稳定版: $UPSTREAM_TAG"

        if [ "$UPSTREAM_TAG" == "null" ] || [ -z "$UPSTREAM_TAG" ]; then
          echo "无法获取上游 release 信息"
          echo "skip=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        # 提取 release body 和 prerelease 状态
        UPSTREAM_BODY=$(echo "$UPSTREAM_RELEASE" | jq -r '.body // ""')
        UPSTREAM_PRERELEASE=$(echo "$UPSTREAM_RELEASE" | jq -r '.prerelease')
        echo "upstream_prerelease=$UPSTREAM_PRERELEASE" >> $GITHUB_OUTPUT

        # body 可能含多行，用文件传递
        echo "$UPSTREAM_BODY" > /tmp/release_body.txt
        echo "上游 prerelease: $UPSTREAM_PRERELEASE"

        # 检查 mod 仓库是否已有该版本的 release
        MOD_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/tags/$UPSTREAM_TAG")

        if [ "$MOD_STATUS" == "200" ]; then
          echo "Mod 仓库已有 $UPSTREAM_TAG release，跳过"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "发现新版本 $UPSTREAM_TAG，开始同步"
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout mod repo
      if: steps.check.outputs.skip != 'true'
      uses: actions/checkout@v6.0.2
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Sync upstream code
      if: steps.check.outputs.skip != 'true'
      run: |
        UPSTREAM_TAG="${{ steps.check.outputs.upstream_tag }}"

        # 备份 mod 仓库的 .github 目录（避免被上游覆盖）
        cp -r .github /tmp/.github-backup

        # 添加上游 remote
        git remote add upstream https://github.com/2dust/v2rayN.git || true
        git fetch upstream --tags --force

        # 配置 git
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # reset 到上游 tag 对应的 commit
        git reset --hard "$UPSTREAM_TAG"

        # 恢复 mod 仓库的 .github 目录
        rm -rf .github
        cp -r /tmp/.github-backup .github
        echo "✅ 已恢复 mod 仓库的 .github 目录"

    - name: Remove promotion code
      if: steps.check.outputs.skip != 'true'
      run: |
        python3 << 'PYTHON_SCRIPT'
        import os
        import sys

        def read_file(file_path):
            with open(file_path, 'r', encoding='utf-8') as f:
                return f.readlines()

        def write_file(file_path, lines):
            with open(file_path, 'w', encoding='utf-8') as f:
                f.writelines(lines)

        def remove_lines_containing(lines, text):
            return [line for line in lines if text not in line]

        def remove_method_block(lines, method_signature):
            final_lines = []
            skip_block = False
            for line in lines:
                if method_signature in line:
                    skip_block = True
                    continue
                if skip_block:
                    if line.strip() == '}':
                        skip_block = False
                        continue
                if not skip_block:
                    final_lines.append(line)
            return final_lines

        def remove_xml_block(lines, identifier):
            result_lines = []
            i = 0
            while i < len(lines):
                line = lines[i]
                if identifier in line:
                    if '/>' in line:
                        start = i
                        while start > 0 and '<MenuItem' not in lines[start]:
                            start -= 1
                        i += 1
                        continue
                    else:
                        start = i
                        while start > 0 and '<MenuItem' not in lines[start]:
                            start -= 1
                        end = i
                        while end < len(lines) and '</MenuItem>' not in lines[end]:
                            end += 1
                        if end < len(lines):
                            end += 1
                        while len(result_lines) > 0 and result_lines[-1] == lines[start]:
                            result_lines.pop()
                            start += 1
                        i = end
                        continue
                result_lines.append(line)
                i += 1
            return result_lines

        def remove_menu_block(lines, identifier):
            start_index = -1
            end_index = -1
            for i, line in enumerate(lines):
                if identifier in line:
                    start_index = i
                    while start_index >= 0 and '<Menu' not in lines[start_index].strip():
                        start_index -= 1
                    end_index = i
                    while end_index < len(lines):
                        if '<Separator' in lines[end_index]:
                            end_index += 1
                            break
                        end_index += 1
                    break
            if start_index >= 0 and end_index >= 0:
                return lines[:start_index] + lines[end_index:]
            return lines

        def remove_duplicate_menu_lines(lines):
            result_lines = []
            prev_line = None
            for line in lines:
                if line.strip() != prev_line:
                    result_lines.append(line)
                    prev_line = line.strip()
            return result_lines

        # 定义要处理的文件和操作
        operations = {
            'v2rayN/ServiceLib/Global.cs': [
                ('remove_lines', 'public const string PromotionUrl')
            ],
            'v2rayN/ServiceLib/ViewModels/CheckUpdateViewModel.cs': [
                ('remove_lines', '_checkUpdateModel.Add(GetCheckUpdateModel(_v2rayN));')
            ],
            'v2rayN/v2rayN.Desktop/Views/MainWindow.axaml': [
                ('remove_xml', 'x:Name="menuPromotion"')
            ],
            'v2rayN/v2rayN.Desktop/Views/MainWindow.axaml.cs': [
                ('remove_lines', 'menuPromotion.Click += MenuPromotion_Click;'),
                ('remove_method', 'private void MenuPromotion_Click')
            ],
            'v2rayN/v2rayN/Views/MainWindow.xaml': [
                ('remove_menu', 'x:Name="menuPromotion"'),
                ('remove_duplicate_menu', None)
            ],
            'v2rayN/v2rayN/Views/MainWindow.xaml.cs': [
                ('remove_lines', 'menuPromotion.Click += MenuPromotion_Click;'),
                ('remove_method', 'private void MenuPromotion_Click')
            ]
        }

        success = 0
        total = len(operations)

        for rel_path, ops in operations.items():
            if not os.path.exists(rel_path):
                print(f"文件不存在，跳过: {rel_path}")
                continue
            try:
                lines = read_file(rel_path)
                for op_type, text in ops:
                    if op_type == 'remove_lines':
                        lines = remove_lines_containing(lines, text)
                    elif op_type == 'remove_method':
                        lines = remove_method_block(lines, text)
                    elif op_type == 'remove_xml':
                        lines = remove_xml_block(lines, text)
                    elif op_type == 'remove_menu':
                        lines = remove_menu_block(lines, text)
                    elif op_type == 'remove_duplicate_menu':
                        lines = remove_duplicate_menu_lines(lines)
                write_file(rel_path, lines)
                success += 1
                print(f"✅ {rel_path}")
            except Exception as e:
                print(f"❌ {rel_path}: {e}")

        print(f"\n处理完成: {success}/{total}")
        if success < total:
            print("⚠️ 部分文件处理失败，但继续执行")
        PYTHON_SCRIPT

    - name: Commit and push
      if: steps.check.outputs.skip != 'true'
      run: |
        UPSTREAM_TAG="${{ steps.check.outputs.upstream_tag }}"

        git add -A
        git commit -m "Sync upstream $UPSTREAM_TAG - Remove promotions and auto-updates"
        git push --force origin master

        # 创建对应的 tag
        git tag -f "$UPSTREAM_TAG"
        git push --force origin "$UPSTREAM_TAG"

    - name: Create release with upstream info
      if: steps.check.outputs.skip != 'true'
      run: |
        UPSTREAM_TAG="${{ steps.check.outputs.upstream_tag }}"
        UPSTREAM_PRERELEASE="${{ steps.check.outputs.upstream_prerelease }}"

        # 用 Python heredoc 构造 JSON 避免转义问题
        export UPSTREAM_TAG UPSTREAM_PRERELEASE
        python3 << 'PYEOF'
        import json, os

        upstream_body = open('/tmp/release_body.txt').read().strip()

        macos_note = (
            "\n\n"
            "---\n"
            "### macOS 用户注意\n\n"
            "如果打开 app 时提示「无法打开」或「移到废纸篓」，请在终端执行：\n\n"
            "```bash\n"
            "# 方法一：移除隔离属性（推荐）\n"
            "xattr -cr /Applications/v2rayN.app\n\n"
            "# 方法二：重新签名\n"
            "codesign --force --deep --sign - /Applications/v2rayN.app\n"
            "```\n"
        )

        body = upstream_body + macos_note

        payload = {
            'tag_name': os.environ['UPSTREAM_TAG'],
            'target_commitish': 'master',
            'name': '',
            'body': body,
            'draft': False,
            'prerelease': os.environ['UPSTREAM_PRERELEASE'] == 'true'
        }
        with open('/tmp/release_payload.json', 'w') as f:
            json.dump(payload, f)
        PYEOF

        echo "预创建 release $UPSTREAM_TAG (prerelease=$UPSTREAM_PRERELEASE)"
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases" \
          -d @/tmp/release_payload.json

        echo "✅ Release 已创建，信息与上游一致"

    - name: Trigger build-all workflow
      if: steps.check.outputs.skip != 'true'
      run: |
        UPSTREAM_TAG="${{ steps.check.outputs.upstream_tag }}"

        echo "触发 build-all.yml，release_tag=$UPSTREAM_TAG"
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-all.yml/dispatches" \
          -d '{"ref":"master","inputs":{"release_tag":"'"$UPSTREAM_TAG"'"}}'

        echo "✅ 构建已触发，版本: $UPSTREAM_TAG"
